name: Build and Publish to PyPI

on:
  release:
    types: [published]
  # Allow manual trigger for testing
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        # Testing: all 3 platforms, cp312 only
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.22
        env:
          # Testing: only cp312 for now
          CIBW_BUILD: cp312-*
          # Build xz from source on Linux (manylinux has old xz without MT decoder API)
          CIBW_BEFORE_ALL_LINUX: |
            XZ_VERSION=5.6.3
            curl -L https://github.com/tukaani-project/xz/releases/download/v${XZ_VERSION}/xz-${XZ_VERSION}.tar.gz | tar xz
            cd xz-${XZ_VERSION}
            ./configure --disable-shared --enable-static --disable-xz --disable-xzdec \
              --disable-lzmadec --disable-lzmainfo --disable-scripts --disable-doc \
              --prefix=/usr/local CFLAGS="-fPIC -O2"
            make -j$(nproc)
            make install
          # Build xz from source as static lib, install to /usr/local (default search path)
          # cibuildwheel sets MACOSX_DEPLOYMENT_TARGET before before-all
          CIBW_BEFORE_ALL_MACOS: |
            XZ_VERSION=5.6.3
            curl -L https://github.com/tukaani-project/xz/releases/download/v${XZ_VERSION}/xz-${XZ_VERSION}.tar.gz | tar xz
            cd xz-${XZ_VERSION}
            ./configure --disable-shared --enable-static --disable-xz --disable-xzdec \
              --disable-lzmadec --disable-lzmainfo --disable-scripts --disable-doc \
              --prefix=/usr/local \
              CFLAGS="-mmacosx-version-min=${MACOSX_DEPLOYMENT_TARGET:-10.13} -O2" \
              LDFLAGS="-mmacosx-version-min=${MACOSX_DEPLOYMENT_TARGET:-10.13}"
            make -j$(sysctl -n hw.ncpu)
            sudo make install
          CIBW_REPAIR_WHEEL_COMMAND_MACOS: ""
          # Windows: use dynamic linking and bundle DLL with delvewheel
          CIBW_BEFORE_ALL_WINDOWS: |
            vcpkg install liblzma:x64-windows
            dir C:\vcpkg\installed\x64-windows\bin
            dir C:\vcpkg\installed\x64-windows\lib
          CIBW_ENVIRONMENT_WINDOWS: 'INCLUDE="C:/vcpkg/installed/x64-windows/include" LIB="C:/vcpkg/installed/x64-windows/lib"'
          CIBW_BEFORE_BUILD_WINDOWS: pip install delvewheel
          CIBW_REPAIR_WHEEL_COMMAND_WINDOWS: 'delvewheel repair -v -w {dest_dir} {wheel} --add-path C:/vcpkg/installed/x64-windows/bin'
          # Testing: only arm64 for now (macos-latest is arm64)
          CIBW_ARCHS_MACOS: arm64
          # Skip 32-bit Windows (vcpkg only has x64)
          CIBW_ARCHS_WINDOWS: AMD64
          CIBW_TEST_COMMAND: python -c "import lzma_mt; print('lzma_mt imported successfully')"

      - uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: ./wheelhouse/*.whl

  build_sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build sdist
        run: pipx run build --sdist

      - uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz

  publish:
    name: Publish to PyPI
    needs: [build_wheels, build_sdist]
    runs-on: ubuntu-latest
    # Only publish on release, not on workflow_dispatch
    if: github.event_name == 'release'

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}